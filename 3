import { create } from "zustand";
import { api } from "../lib/api";

interface Note {
  id: number;
  name: string;
  text: string;
  folder_num: number | null;
}

interface Folder {
  id: number;
  name: string;
}

interface NotesStore {
  notes: Note[];
  currentNote: Note | null;
  folders: Folder[];

  setNotes: (notes: Note[]) => void;
  setCurrentNote: (note: Note) => void;
  updateCurrentNoteName: (name: string) => void;
  updateCurrentNoteText: (text: string) => void;
  getNote: (id: number | string) => Note | undefined;
  saveCurrentNote: () => void;
  createNote: () => void;
  deleteNote: (id: number) => void;
  createFolder: () => void;
  setFolders: () => void;
}

const useNotesStore = create<NotesStore>((set, get) => ({
  notes: [],
  currentNote: null,
  folders: [],

  setNotes: (notes) => set({ notes }),
  setCurrentNote: (note) => set({ currentNote: note }),

  //Updates the name and stores it in the new notes array
  updateCurrentNoteName: (name) =>
    set((state) => {
      if (!state.currentNote) return {};

      const updated = { ...state.currentNote, name };

      return {
        currentNote: updated,
        notes: state.notes.map((n) =>
          n.id === updated.id ? updated : n
        ),
      };
    }),

  //Updates the text and stores it in the new notes array
  updateCurrentNoteText: (text) =>
    set((state) => {
      if (!state.currentNote) return {};

      const updated = { ...state.currentNote, text };

      return {
        currentNote: updated,
        notes: state.notes.map((n) =>
          n.id === updated.id ? updated : n
        ),
      };
    }),
  getNote: (id) => {
    const state = get();
    return state.notes.find(note => note.id === id);
  },

  saveCurrentNote: async () => {
    const { currentNote } = get();
    if (!currentNote) return {};
    api.put(`/api/notes/${currentNote.id}`, {
      name: currentNote.name,
      text: currentNote.text,
    });

  },
  createNote: () => {
    const { notes } = get();
    const nextId = //Since laravel stores the changed notes at the bottom i will recurr to biggest id instead of the last
      notes.length > 0
        ? Math.max(...notes.map((n) => n.id)) + 1
        : 1;
    const newNote: Note = { id: nextId, name: "Untitled", text: "Dummy text", folder_num: null };//Create a new Note
    //Send it to laravel too
    api.post("/api/notes", {
      name: "Untitled",
      text: "Dummy text",
      folder_num: null,
    });
    set({ notes: [...notes, newNote] })//Append it to the array and the current note
    return newNote.id;
  },
  deleteNote: (id) => {
    const { notes, currentNote } = get();
    const filteredNotes = notes.filter(note => note.id != id);
    if (currentNote) {
      api.delete(`/api/notes/${currentNote.id}`);
    }
    set({ notes: filteredNotes })
  },

  createFolder: () => {
    api.post("/api/folders", {
      name: "Test",
    })
  },

  getFolders: async () => {
    const folders = await api.get("/api/folders");
    console.log(folders.data);
    return folders;
  },
}));

export default useNotesStore;
